<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>Math Royale</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<style>
* {
box-sizing: border-box;
}
body {
font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
background: #f0f5ff;
margin: 0;
padding: 16px 0;
color: #333;
min-height: 100vh;
display: block;
touch-action: manipulation;
}
.container {
width: 95%;
max-width: 800px;
background: white;
padding: 16px;
border-radius: 16px;
box-shadow: 0 4px 12px rgba(0,0,0,0.1);
margin: 0 auto;
}
h1 {
text-align: center;
color: #2c3e50;
margin-top: 0;
font-size: 24px;
}
.score-time {
display: flex;
justify-content: space-between;
margin-bottom: 16px;
font-weight: bold;
align-items: center;
font-size: 16px;
}
.timer-bar {
height: 8px;
background: #e0e0e0;
border-radius: 4px;
overflow: hidden;
margin-top: 6px;
}
.timer-fill {
height: 100%;
background: #0984e3;
width: 100%;
transition: width 0.1s linear;
}
.target-row {
display: flex;
justify-content: center;
margin: 16px 0;
}
.target-card {
width: 60px;
height: 80px;
border: 3px solid #d63031;
border-radius: 10px;
display: flex;
align-items: center;
justify-content: center;
font-size: 18px;
font-weight: bold;
background: #ffeaa7;
}
.hand-area {
min-height: 110px;
height: 110px;
max-height: 110px;
margin: 16px 0;
padding: 0 8px;
background: #fafafa;
border-radius: 12px;
display: flex;
flex-wrap: nowrap;
gap: 10px;
justify-content: center;
align-items: center;
overflow-x: hidden;
overflow-y: hidden;
}
.card {
width: calc(16vw - 12px);
min-width: 50px;
max-width: 60px;
flex-shrink: 0;
height: 80px;
border: 3px solid #333;
border-radius: 10px;
display: flex;
align-items: center;
justify-content: center;
font-size: 16px;
font-weight: bold;
background: white;
cursor: pointer;
-webkit-tap-highlight-color: transparent;
transition: all 0.2s;
}
.card.selected-first {
border-color: #0984e3;
transform: scale(1.08);
box-shadow: 0 0 16px rgba(9, 132, 227, 0.6);
}
.operator-menu {
display: none;
justify-content: center;
gap: 14px;
margin: 16px 0;
flex-wrap: wrap;
height: 60px;
}
.op-btn {
width: 50px;
height: 50px;
font-size: 22px;
font-weight: bold;
border: none;
border-radius: 50%;
background: #0984e3;
color: white;
cursor: pointer;
}
.cancel-btn {
padding: 8px 16px;
background: #ff7675;
color: white;
border: none;
border-radius: 8px;
cursor: pointer;
font-weight: bold;
font-size: 14px;
}
.buttons {
display: flex;
gap: 12px;
flex-wrap: wrap;
justify-content: center;
margin: 20px 0;
}
button {
padding: 10px 16px;
font-size: 16px;
border: none;
border-radius: 10px;
cursor: pointer;
background: #0984e3;
color: white;
font-weight: bold;
}
#hintBtn { background: #00b894; }
#nextBtn { background: #fdcb6e; color: #2d3436; }
#resetBtn { background: #a29bfe; }
#createGameBtn { background: #e17055; }
#volumeBtn { background: #6c5ce7; color: white; }
#volumeBtn.muted { background: #636e72; color: #dfe6e9; }
.message {
margin-top: 16px;
padding: 12px;
border-radius: 10px;
font-weight: bold;
text-align: center;
font-size: 14px;
}
.success { background: #d5f4e6; color: #00a86b; }
.error { background: #ffdddd; color: #d63031; }
.info { background: #e3f2fd; color: #0984e3; }
/* Modal é€šç”¨ */
.modal,
#successModal,
#failureModal,
#instructionsModal {
display: none;
position: fixed;
z-index: 1000;
left: 0;
top: 0;
width: 100%;
height: 100%;
background-color: rgba(0,0,0,0.6);
overflow: auto;
justify-content: center;
align-items: center;
}
/* æˆåŠŸ/å¤±æ•—å½ˆçª— */
#successModal .modal-content,
#failureModal .modal-content {
display: inline-block;
background: white;
padding: 16px;
border-radius: 12px;
text-align: center;
box-shadow: 0 6px 24px rgba(0,0,0,0.3);
min-width: 280px;
max-width: 90vw;
font-size: 15px;
}
#successModal .modal-content {
background: #d5f4e6;
border: 2px solid #00a86b;
}
#successTimeMessage {
color: #00a86b;
margin-top: 0;
margin-bottom: 8px;
font-size: 18px;
}
#successMessage {
font-size: 14px;
margin: 10px 0;
color: #006400;
}
#failureModal .modal-content {
background: #ffebee;
border: 2px solid #d63031;
}
#failureModal h2 {
color: #d63031;
margin-top: 0;
margin-bottom: 16px;
font-size: 20px;
}
#failureMessage {
font-size: 16px;
margin: 16px 0;
color: #8B0000;
}
/* ===== ç©æ³•èªªæ˜å½ˆçª—æ¨£å¼ï¼ˆç™½è‰²èƒŒæ™¯ï¼‰===== */
#instructionsModal .modal-content {
background: white;
padding: 20px;
border-radius: 12px;
text-align: left;
max-width: 90vw;
max-height: 80vh;
overflow-y: auto;
box-shadow: 0 6px 24px rgba(0,0,0,0.3);
position: relative;
}
#instructionsModal .close {
float: right;
font-size: 24px;
font-weight: bold;
cursor: pointer;
color: #aaa;
}
#instructionsModal .close:hover {
color: #000;
}
#langToggleInModal {
position: absolute;
top: 16px;
right: 16px;
background: #6c5ce7;
color: white;
border: none;
width: 36px;
height: 36px;
border-radius: 50%;
font-size: 16px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
z-index: 10;
}
.action-buttons {
display: flex;
gap: 10px;
margin-top: 20px;
width: 100%;
}
.action-btn {
flex: 1;
padding: 10px 6px;
border: none;
border-radius: 8px;
font-size: 14px;
font-weight: bold;
cursor: pointer;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
min-height: 60px;
}
.btn-icon {
font-size: 20px;
margin-bottom: 4px;
display: block;
}
.restart-btn {
background: #6c5ce7;
color: white;
}
.continue-btn {
background: #00a86b;
color: white;
}
#failureModal .continue-btn {
background: #d63031;
}
/* åˆ†äº«æŒ‰éˆ•æ¨£å¼ */
.share-btn {
background: #e17055;
color: white;
border: none;
border-radius: 8px;
padding: 10px;
font-size: 14px;
font-weight: bold;
cursor: pointer;
margin-top: 12px;
display: flex;
align-items: center;
justify-content: center;
gap: 6px;
width: 100%;
}
.share-btn:hover {
background: #d63031;
}
/* éŠæˆ²å¤§å»³åˆ—è¡¨ */
#gamesList {
margin-top: 20px;
}
#gameItems {
list-style: none;
padding: 0;
}
#gameItems li {
padding: 12px;
border-bottom: 1px solid #eee;
}
#gameItems a {
color: #0984e3;
text-decoration: underline;
}
.hall-of-fame {
margin-top: 20px;
padding-top: 20px;
border-top: 1px solid #eee;
}
.hall-of-fame h3 {
text-align: center;
margin-bottom: 12px;
color: #2c3e50;
}
.hall-item {
padding: 8px 0;
display: flex;
justify-content: space-between;
font-size: 14px;
}
.hall-status.success { color: #00a86b; }
.hall-status.failure { color: #d63031; }
</style>
</head>
<body>
<div class="container" id="mainContainer">
  <!-- å…§å®¹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
</div>

<!-- ç©æ³•èªªæ˜å½ˆçª— -->
<div id="instructionsModal" class="modal">
<div class="modal-content">
<button id="langToggleInModal" onclick="toggleLanguageInModal()">ğŸŒ</button>
<span class="close" onclick="closeInstructions()">&times;</span>
<div class="instructions">
<h2 id="instructionsTitle">ğŸ® ç©æ³•èªªæ˜</h2>
<ul id="instructionsList">
<li><strong>ğŸ¯ ç›®æ¨™</strong><br>åœ¨ 60 ç§’å…§ç”¨å…¨éƒ¨ 5 å¼µç‰Œç®—å‡ºç›®æ¨™å€¼</li>
<li><strong>ğŸ® æ“ä½œæ­¥é©Ÿ</strong><br>1ï¸âƒ£ é»æ“Šç¬¬ä¸€å¼µå¡<br>2ï¸âƒ£ é¸æ“‡é‹ç®—ç¬¦ï¼ˆ+ âˆ’ Ã— Ã·ï¼‰<br>3ï¸âƒ£ é»æ“Šç¬¬äºŒå¼µå¡ â†’ è‡ªå‹•è¨ˆç®—</li>
<li><strong>âœ… å…è¨± / âŒ ç¦æ­¢</strong><br>âœ… å¯ä»¥ä½¿ç”¨åŠ ã€æ¸›ã€ä¹˜ã€é™¤<br>âœ… å¯ä»¥é‡è¤‡ä½¿ç”¨é‹ç®—ç¬¦<br>âŒ ä¸èƒ½ç”¢ç”Ÿè² æ•¸<br>âŒ é™¤æ³•å¿…é ˆæ•´é™¤ï¼ˆç„¡é¤˜æ•¸ï¼‰<br>âŒ ä¸èƒ½é™¤ä»¥é›¶<br>âŒ ä¸èƒ½å°‡å…©å¼µç›¸åŒæ•¸å€¼çš„å¡ç‰Œç›¸æ¸›</li>
<li><strong>ğŸ† è¨ˆåˆ†</strong><br>æˆåŠŸè§£é¡Œï¼š+100 åˆ†<br>å‰©é¤˜æ™‚é–“ï¼šæ¯ç§’ +10 åˆ†</li>
</ul>
<p style="text-align:center; margin-top:16px;">
<button onclick="startGameFromInstructions()" id="startGameBtn">é–‹å§‹éŠæˆ²ï¼</button>
</p>
</div>
</div>
</div>

<!-- æˆåŠŸå½ˆå‡ºç•«é¢ -->
<div id="successModal">
<div class="modal-content">
<h2 id="successTimeMessage">ğŸ‰ ä½ èŠ±äº† X ç§’å®Œæˆï¼</h2>
<p id="successMessage"></p>
<button class="share-btn" onclick="submitToHall()">
<span>ğŸ†</span>
<span id="submitBtnText">æäº¤åˆ°å¤§å»³</span>
</button>
<div class="action-buttons">
<button class="action-btn restart-btn" onclick="restartGame()">
<span class="btn-icon">ğŸ”„</span>
<span id="restartBtnText">é‡æ–°é–‹å§‹</span>
</button>
<button class="action-btn continue-btn" onclick="continueChallenge()">
<span class="btn-icon">âš¡</span>
<span id="continueBtnText">ç¹¼çºŒæŒ‘æˆ°</span>
</button>
</div>
</div>
</div>

<!-- å¤±æ•—å½ˆå‡ºç•«é¢ -->
<div id="failureModal">
<div class="modal-content">
<h2 id="failureTitle">ğŸ’ª å†è©¦ä¸€æ¬¡ï¼</h2>
<p id="failureMessage"></p>
<button class="share-btn" onclick="submitToHall()">
<span>ğŸ†</span>
<span id="submitBtnText2">æäº¤åˆ°å¤§å»³</span>
</button>
<div class="action-buttons">
<button class="action-btn restart-btn" onclick="restartGame()">
<span class="btn-icon">ğŸ”„</span>
<span id="restartBtnText2">é‡æ–°é–‹å§‹</span>
</button>
<button class="action-btn continue-btn" onclick="continueChallenge()">
<span class="btn-icon">âš¡</span>
<span id="continueBtnText2">ç¹¼çºŒæŒ‘æˆ°</span>
</button>
</div>
</div>
</div>

<script>
// ===== STEP 1: æ›¿æ›ç‚ºæ‚¨çš„ Firebase è¨­å®š =====
  const firebaseConfig = {
    apiKey: "AIzaSyAvSql6l9nYGbGjrELDiae6qSE-YEDQ8Ug",
    authDomain: "math-royale-lobby.firebaseapp.com",
    databaseURL: "https://math-royale-lobby-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "math-royale-lobby",
    storageBucket: "math-royale-lobby.firebasestorage.app",
    messagingSenderId: "763474729637",
    appId: "1:763474729637:web:568a8f693e85f6dc590b4c"
  };

// åˆå§‹åŒ– Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const gamesRef = database.ref('games');
const resultsRef = database.ref('results');

// ===== STEP 2: Math Royale æ ¸å¿ƒè®Šæ•¸ =====
const VALUE_TO_RANK = {1:'A',2:'2',3:'3',4:'4',5:'5',6:'6',7:'7',8:'8',9:'9',10:'10',11:'J',12:'Q',13:'K'};
const SUITS = ['â™ ','â™¥','â™¦','â™£'];
let currentTarget = null;
let originalHand = [];
let selectedCard1 = null;
let selectedOperator = null;
let score = 0;
let combo = 0;
let timeLeft = 60;
let timer = null;
let isGameActive = false;
let currentStep = 0;
let currentGameId = null;
let volumeEnabled = true;
let currentLang = 'zh';

// ===== STEP 3: å·¥å…·å‡½æ•¸ =====
function getRandomSuit() {
  return SUITS[Math.floor(Math.random() * SUITS.length)];
}

function valueToDisplay(value) {
  if (value >= 1 && value <= 13) {
    return VALUE_TO_RANK[value] + getRandomSuit();
  }
  return String(Math.round(value * 100) / 100);
}

function createCard(value, isNew = false) {
  const card = document.createElement('div');
  card.className = 'card';
  card.textContent = valueToDisplay(value);
  card.dataset.value = value;
  card.onclick = (e) => {
    e.stopPropagation();
    selectCard(card);
  };
  return card;
}

function toggleVolume() {
  volumeEnabled = !volumeEnabled;
  const volumeBtn = document.getElementById('volumeBtn');
  if (volumeEnabled) {
    volumeBtn.textContent = 'ğŸ”Š';
    volumeBtn.classList.remove('muted');
  } else {
    volumeBtn.textContent = 'ğŸ”‡';
    volumeBtn.classList.add('muted');
  }
}

// ===== STEP 4: éŠæˆ²é‚è¼¯ (ç°¡åŒ–ç‰ˆ) =====
function generateUniquePuzzle() {
  // å¯¦éš›ä½¿ç”¨æ‚¨çš„å®Œæ•´é¡Œç›®ç”Ÿæˆé‚è¼¯
  const patterns = [
    { hand: [3, 7, 2, 10, 5], target: 24 },
    { hand: [4, 8, 3, 2, 10], target: 24 },
    { hand: [6, 3, 8, 2, 1], target: 24 },
    { hand: [9, 5, 2, 4, 1], target: 24 },
    { hand: [7, 3, 8, 2, 1], target: 24 }
  ];
  return patterns[Math.floor(Math.random() * patterns.length)];
}

function startTimer() {
  if (timer) clearInterval(timer);
  timeLeft = 60;
  isGameActive = true;
  updateTimerUI();
  timer = setInterval(() => {
    if (!isGameActive || currentTarget === null) {
      clearInterval(timer);
      timer = null;
      return;
    }
    timeLeft--;
    updateTimerUI();
    if (timeLeft <= 0) {
      clearInterval(timer);
      timer = null;
      isGameActive = false;
      showFailureScreen();
    }
  }, 1000);
}

function updateTimerUI() {
  document.getElementById('timeLeft').textContent = timeLeft;
  const fill = document.getElementById('timerFill');
  if (fill) {
    const percent = Math.max(0, timeLeft / 60 * 100);
    fill.style.width = percent + '%';
    if (timeLeft <= 18) {
      fill.style.background = '#d63031';
    } else {
      fill.style.background = '#0984e3';
    }
  }
}

function addScore(base, timeBonus = 0) {
  let total = base + timeBonus;
  if (combo > 1) {
    total = Math.floor(total * (1 + (combo - 1) * 0.2));
  }
  score += total;
  document.getElementById('score').textContent = score;
}

function selectCard(card) {
  if (!isGameActive) return;
  if (selectedOperator !== null) {
    if (card === selectedCard1) return;
    performCalculation(card);
    return;
  }
  if (selectedCard1 === null) {
    selectedCard1 = card;
    card.classList.add('selected-first');
    document.getElementById('operatorMenu').style.display = 'flex';
  } else if (card === selectedCard1) {
    clearSelection();
  } else {
    selectedCard1.classList.remove('selected-first');
    selectedCard1 = card;
    card.classList.add('selected-first');
  }
}

function selectOperator(op) {
  if (selectedCard1 === null || !isGameActive) return;
  selectedOperator = op;
}

function performCalculation(secondCard) {
  const val1 = parseFloat(selectedCard1.dataset.value);
  const val2 = parseFloat(secondCard.dataset.value);
  let result;
  switch(selectedOperator) {
    case '+': result = val1 + val2; break;
    case 'âˆ’': 
      if (Math.abs(val1 - val2) < 1e-9) return;
      result = val1 - val2;
      break;
    case 'Ã—': result = val1 * val2; break;
    case 'Ã·':
      if (Math.abs(val2) < 1e-9) return;
      if (Math.abs(val1 % val2) > 1e-9) return;
      result = val1 / val2;
      break;
    default: clearSelection(); return;
  }
  if (result < 0) {
    clearSelection();
    return;
  }
  selectedCard1.remove();
  secondCard.remove();
  const newCard = createCard(result, true);
  document.getElementById('handArea').appendChild(newCard);
  clearSelection();
  currentStep++;
  const remainingCardsAfter = document.querySelectorAll('.card').length;
  if (remainingCardsAfter === 1) {
    const finalValue = parseFloat(document.querySelector('.card').dataset.value);
    if (Math.abs(finalValue - currentTarget) < 1e-6) {
      const timeBonus = timeLeft * 10;
      combo++;
      addScore(100, timeBonus);
      clearInterval(timer);
      timer = null;
      isGameActive = false;
      showSuccessScreen();
    } else {
      combo = 0;
      clearInterval(timer);
      timer = null;
      isGameActive = false;
      showFailureScreen();
    }
  }
}

function cancelSelection() {
  clearSelection();
}

function clearSelection() {
  if (selectedCard1) {
    selectedCard1.classList.remove('selected-first');
    selectedCard1 = null;
  }
  selectedOperator = null;
  document.getElementById('operatorMenu').style.display = 'none';
}

function resetHand() {
  if (!isGameActive) return;
  clearSelection();
  const handArea = document.getElementById('handArea');
  handArea.innerHTML = '';
  for (let i = 0; i < originalHand.length; i++) {
    handArea.appendChild(createCard(originalHand[i]));
  }
  currentStep = 0;
  startTimer();
}

function showHint() {
  return currentLang === 'en' 
    ? "Look for pairs that can be evenly divided" 
    : "å°‹æ‰¾å¯ä»¥æ•´é™¤çš„æ•¸å­—å°";
}

function showMessage(text, type) {
  const msg = document.getElementById('message');
  msg.textContent = text;
  msg.className = 'message ' + type;
}

function showSuccessScreen() {
  const usedTime = 60 - timeLeft;
  document.getElementById('successTimeMessage').textContent = 
    currentLang === 'en' 
      ? `ğŸ‰ You completed it in ${usedTime} seconds!` 
      : `ğŸ‰ ä½ èŠ±äº† ${usedTime} ç§’å®Œæˆï¼`;
  document.getElementById('successMessage').textContent = 
    currentLang === 'en' 
      ? "Perfect solution! Well done!" 
      : "å®Œç¾è§£é¡Œï¼çœŸæ£’ï¼";
  document.getElementById('successModal').style.display = 'flex';
}

function showFailureScreen() {
  document.getElementById('failureMessage').textContent = 
    currentLang === 'en' 
      ? "Don't worry, try again!" 
      : "æ²’é—œä¿‚ï¼Œå†è©¦ä¸€æ¬¡ï¼";
  document.getElementById('failureModal').style.display = 'flex';
}

// ===== STEP 5: Firebase æ•´åˆ =====
async function createNewGame() {
  const puzzle = generateUniquePuzzle();
  const gameId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
  
  try {
    await gamesRef.child(gameId).set({
      hand: puzzle.hand,
      target: puzzle.target,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    });
    
    // æ›´æ–° URL
    const url = new URL(window.location);
    url.searchParams.set('gameId', gameId);
    window.history.pushState({}, '', url);
    
    // è¼‰å…¥éŠæˆ²
    currentGameId = gameId;
    currentTarget = puzzle.target;
    originalHand = [...puzzle.hand];
    
    renderGameUI();
    startTimer();
  } catch (err) {
    console.error('Create game failed:', err);
    showMessage('âŒ å‰µå»ºéŠæˆ²å¤±æ•—', 'error');
  }
}

async function loadGameById(gameId) {
  try {
    const snapshot = await gamesRef.child(gameId).once('value');
    if (!snapshot.exists()) {
      showMessage('éŠæˆ²ä¸å­˜åœ¨', 'error');
      showHallOfFame();
      return;
    }
    
    const data = snapshot.val();
    currentGameId = gameId;
    currentTarget = data.target;
    originalHand = data.hand;
    
    renderGameUI();
    showMessage('ğŸ¯ é»æ“Šç¬¬ä¸€å¼µå¡ç‰Œï¼', 'info');
  } catch (err) {
    console.error('Load game failed:', err);
    showMessage('è¼‰å…¥éŠæˆ²å¤±æ•—', 'error');
    showHallOfFame();
  }
}

async function submitToHall() {
  if (!currentGameId) {
    showMessage('è«‹å¾éŠæˆ²å¤§å»³é€²å…¥éŠæˆ²', 'error');
    return;
  }
  
  if (!isGameActive && (document.getElementById('successModal').style.display === 'flex' || 
                        document.getElementById('failureModal').style.display === 'flex')) {
    
    const usedTime = 60 - timeLeft;
    const finalScore = score;
    const isSuccess = document.getElementById('successModal').style.display === 'flex';
    
    if (finalScore > 1000 || usedTime <= 0) {
      showMessage('ç„¡æ•ˆçµæœ', 'error');
      return;
    }
    
    try {
      await resultsRef.child(currentGameId).push({
        status: isSuccess ? 'success' : 'failure',
        time: usedTime,
        score: finalScore,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        lang: currentLang
      });
      
      showMessage(
        currentLang === 'en' 
          ? 'âœ… Result submitted!' 
          : 'âœ… çµæœå·²æäº¤ï¼', 
        'success'
      );
      
      // é—œé–‰å½ˆçª—
      document.getElementById('successModal').style.display = 'none';
      document.getElementById('failureModal').style.display = 'none';
      
      // é‡æ–°è¼‰å…¥æ’è¡Œæ¦œ
      loadResultsForCurrentGame();
      
    } catch (err) {
      console.error('Submit failed:', err);
      showMessage('âŒ æäº¤å¤±æ•—', 'error');
    }
  }
}

function loadResultsForCurrentGame() {
  if (!currentGameId) return;
  
  const hallDiv = document.getElementById('hallOfFame');
  if (!hallDiv) return;
  
  hallDiv.innerHTML = '<p style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</p>';
  
  resultsRef.child(currentGameId)
    .orderByChild('timestamp')
    .limitToLast(10)
    .once('value')
    .then(snapshot => {
      const results = [];
      snapshot.forEach(child => {
        results.push(child.val());
      });
      
      if (results.length === 0) {
        hallDiv.innerHTML = '<h3>ğŸ† å°šç„¡æŒ‘æˆ°è€…</h3>';
        return;
      }
      
      // æ’åºï¼šæˆåŠŸå„ªå…ˆï¼Œæ™‚é–“çŸ­å„ªå…ˆ
      results.sort((a, b) => {
        if (a.status !== b.status) return a.status === 'success' ? -1 : 1;
        return a.time - b.time;
      });
      
      hallDiv.innerHTML = `
        <h3>ğŸ† æ’è¡Œæ¦œ (${results.length} äºº)</h3>
        <div class="hall-list">
          ${results.map(r => `
            <div class="hall-item">
              <span class="hall-status ${r.status}">${r.status === 'success' ? 'âœ…' : 'âŒ'}</span>
              <span>${r.time}ç§’ | ${r.score}åˆ†</span>
            </div>
          `).join('')}
        </div>
      `;
    })
    .catch(err => {
      console.error('Load results failed:', err);
      hallDiv.innerHTML = '<p style="text-align:center; color:#d63031;">è¼‰å…¥å¤±æ•—</p>';
    });
}

// ===== STEP 6: UI æ¸²æŸ“ =====
function renderGameUI() {
  const container = document.getElementById('mainContainer');
  container.innerHTML = `
    <h1>Math Royale</h1>
    <div class="score-time">
      <div>ğŸ† åˆ†æ•¸: <span id="score">0</span></div>
      <div>â±ï¸ æ™‚é–“: <span id="timeLeft">60</span>s</div>
    </div>
    <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
    <div class="target-row">
      <div class="target-card" id="targetCard">${valueToDisplay(currentTarget)}</div>
    </div>
    <div class="hand-area" id="handArea"></div>
    <div class="operator-menu" id="operatorMenu">
      <button class="op-btn" onclick="selectOperator('+')">+</button>
      <button class="op-btn" onclick="selectOperator('âˆ’')">âˆ’</button>
      <button class="op-btn" onclick="selectOperator('Ã—')">Ã—</button>
      <button class="op-btn" onclick="selectOperator('Ã·')">Ã·</button>
      <button class="cancel-btn" onclick="cancelSelection()">å–æ¶ˆ</button>
    </div>
    <div class="buttons">
      <button id="hintBtn" onclick="showMessage(showHint(), 'info')">æç¤º</button>
      <button id="createGameBtn" onclick="showHallOfFame()">è¿”å›å¤§å»³</button>
      <button id="resetBtn" onclick="resetHand()">é‡ä¾†</button>
      <button id="volumeBtn" onclick="toggleVolume()" title="é–‹é—œéŸ³æ•ˆ">ğŸ”Š</button>
    </div>
    <div id="message" class="message info">ğŸ¯ é»æ“Šç¬¬ä¸€å¼µå¡ç‰Œï¼</div>
    
    <!-- æ’è¡Œæ¦œå€å¡Š -->
    <div class="hall-of-fame" id="hallOfFame">
      <h3>ğŸ† å°šç„¡æŒ‘æˆ°è€…</h3>
    </div>
  `;
  
  // åˆå§‹åŒ–æ‰‹ç‰Œ
  const handArea = document.getElementById('handArea');
  handArea.innerHTML = '';
  for (let i = 0; i < originalHand.length; i++) {
    handArea.appendChild(createCard(originalHand[i]));
  }
  
  // é‡ç½®ç‹€æ…‹
  score = 0;
  combo = 0;
  currentStep = 0;
  document.getElementById('score').textContent = '0';
  
  // è¼‰å…¥æ’è¡Œæ¦œ
  loadResultsForCurrentGame();
}

async function showHallOfFame() {
  const container = document.getElementById('mainContainer');
  container.innerHTML = `
    <h1>Math Royale éŠæˆ²å¤§å»³</h1>
    <button id="createGameBtn" style="display:block; margin:20px auto; padding:12px 24px;">ğŸ†• å‰µå»ºæ–°éŠæˆ²</button>
    <div id="gamesList">
      <h2>ğŸ® å¯æŒ‘æˆ°çš„éŠæˆ²</h2>
      <ul id="gameItems"><li style="text-align:center; color:#999;">è¼‰å…¥ä¸­...</li></ul>
    </div>
  `;
  
  document.getElementById('createGameBtn').addEventListener('click', createNewGame);
  loadGamesList();
}

async function loadGamesList() {
  const gameItems = document.getElementById('gameItems');
  try {
    const snapshot = await gamesRef.orderByChild('createdAt').limitToLast(20).once('value');
    const games = [];
    snapshot.forEach(child => {
      games.push({ id: child.key, ...child.val() });
    });
    games.reverse();
    
    if (games.length === 0) {
      gameItems.innerHTML = '<li style="text-align:center; color:#999;">å°šç„¡éŠæˆ²</li>';
      return;
    }
    
    gameItems.innerHTML = '';
    games.forEach(game => {
      const timeStr = new Date(game.createdAt).toLocaleString('zh-TW');
      const li = document.createElement('li');
      li.innerHTML = `
        <a href="?gameId=${game.id}" style="color:#0984e3; text-decoration:underline;">
          ğŸ¯ ç›®æ¨™: ${game.target} | ç‰Œ: ${game.hand.join(', ')}
        </a>
        <div style="font-size:12px; color:#666; margin-top:4px;">${timeStr}</div>
      `;
      gameItems.appendChild(li);
    });
  } catch (err) {
    console.error('Load games failed:', err);
    gameItems.innerHTML = '<li style="text-align:center; color:#d63031;">è¼‰å…¥å¤±æ•—</li>';
  }
}

// ===== STEP 7: æŒ‰éˆ•äº‹ä»¶ =====
function restartGame() {
  if (currentGameId) {
    loadGameById(currentGameId);
  } else {
    showHallOfFame();
  }
}

function continueChallenge() {
  showHallOfFame();
}

function closeInstructions() {
  alert(currentLang === 'en' ? 'Please click "Start Game!" button to begin.' : 'è«‹é»æ“Šã€Œé–‹å§‹éŠæˆ²ï¼ã€æŒ‰éˆ•ä»¥é–‹å§‹éŠæˆ²ã€‚');
}

function startGameFromInstructions() {
  document.getElementById('instructionsModal').style.display = 'none';
  showHallOfFame();
}

// ===== STEP 8: å•Ÿå‹•æµç¨‹ =====
window.addEventListener('load', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const gameId = urlParams.get('gameId');
  
  if (gameId) {
    loadGameById(gameId);
  } else {
    // é¡¯ç¤ºç©æ³•èªªæ˜æˆ–ç›´æ¥é€²å…¥å¤§å»³
    document.getElementById('instructionsModal').style.display = 'flex';
    // æˆ–ç›´æ¥é€²å…¥å¤§å»³ï¼šshowHallOfFame();
  }
});

// è™•ç†ç€è¦½å™¨è¿”å›æŒ‰éˆ•
window.addEventListener('popstate', () => {
  const urlParams = new URLSearchParams(window.location.search);
  const gameId = urlParams.get('gameId');
  if (gameId) {
    loadGameById(gameId);
  } else {
    showHallOfFame();
  }
});
</script>
</body>
</html>
